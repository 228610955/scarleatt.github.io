"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function game(e){var t=$("#canvas-container")[0],i=$(".time-score cite")[0],a=($(".time-to-stop")[0],$(".no-dissloved")[0]),n=window.location.href,s=$(".time-record cite")[0],r=0;if($(".higest-score p"))var o=$(".higest-score p")[0];screen.height<500&&($(".canvas-container")[0].style.height="9.4rem"),$(document).ready(function(){var c=Number($("html").attr("data-dpr")),l={width:Number(window.getComputedStyle(t,null).getPropertyValue("width").slice(0,-2))-13*c,height:Number(window.getComputedStyle(t,null).getPropertyValue("height").slice(0,-2))-11*c},m={canvas:document.getElementById("canvas"),ctx:document.getElementById("canvas").getContext("2d"),xNum:6,yNum:8,imgWidth:l.width/6,imgHeight:l.height/8,timeCount:10,passOneNeedScore:2500,passTwoNeedScore:5e3,passThreeNeedScore:7e3,extraScore:10,halfWidth:20,clickedImgIndex:0,setWH:function(e){e.style.width=screen.width+"px",e.style.height=screen.height+"px"}};m.canvas.width=l.width,m.canvas.height=l.height;var d={allImgs:$(".time-imgs .allimg").children(),clickedImg:$(".time-imgs .img-clicked").children(),disslovedImg:$(".time-imgs .img-dissloved").children(),moveFlag:!1,clickedFlag:!1,score:0,imgPlaceStay:function(){f={x:g.x,y:g.y}}},u={},g={},f={},h=[],y=0,v=void 0,k=0,p=!0;e?v=!0:(v=!1,k=1,d.allImgs=$(".pass-one-imgs .allimg").children(),d.clickedImg=$(".pass-one-imgs .img-clicked").children(),d.disslovedImg=$(".pass-one-imgs .img-dissloved").children());var x=function(){function e(){_classCallCheck(this,e),this.ctx=m.ctx}return _createClass(e,[{key:"refresh",value:function(){this.ctx.clearRect(0,0,this.width,this.height)}},{key:"drawPictures",value:function(){for(var e=0;e<=m.xNum-1;e++){h[e]=new Array;for(var t=0;t<=m.yNum-1;t++){var i=d.allImgs.length,a=Math.round(Math.random()*(i-1)+0),n=new S(m.ctx,e*m.imgWidth,t*m.imgHeight,d.allImgs[a],!1,!0);h[e][t]=n,n.paint()}}}},{key:"drawTimeStage",value:function(){var e=0;h[e][e].toClick=!1,h[e+1][e].toClick=!1,h[e][e+1].toClick=!1;var t=m.xNum-1;h[t][e].toClick=!1,h[t-1][e].toClick=!1,h[t][e+1].toClick=!1;var i=m.yNum-1;h[e][i].toClick=!1,h[e][i-1].toClick=!1,h[e+1][i].toClick=!1,h[t][i].toClick=!1,h[t-1][i].toClick=!1,h[t][i-1].toClick=!1,h.forEach(function(e,t){e.forEach(function(e,t){e.toClick||e.refresh()})})}},{key:"drawPassTwo",value:function(){var e=m.xNum-1,t=m.yNum-1;h[0][0].toClick=!1,h[e][0].toClick=!1,h[0][t].toClick=!1,h[e][t].toClick=!1,h.forEach(function(e,t){e.forEach(function(e,t){e.toClick||e.refresh()})})}},{key:"drawAllStage",value:function(){v||1==k?(I.drawTimeStage(),$(".canvas-container").attr("style","background-image: url(../images/game-time-border.png)")):2==k?($(".canvas-container").attr("style","background-image: url(../images/pass2-bg.png)"),I.drawPassTwo()):3==k&&$(".canvas-container").attr("style","background-image: url(../images/pass3-bg.png)")}},{key:"drawStage",value:function(){for(var e=0;e<=m.xNum-1;e++)for(var t=0;t<=m.yNum-1;t++)h[e][t].toClick&&h[e][t].paint()}},{key:"drawNewImg",value:function(e,t,i){var a=d.allImgs.length,n=Math.round(Math.random()*(a-1)+0);return e[t][i].img=d.allImgs[n],n}},{key:"findYSameImg",value:function(e,t,i){if(h[t][i+e]&&h[t][i+e].toClick){for(var a=0;a<e&&(!h[t][i+a+1]||h[t][i+a].img===h[t][i+a+1].img);a++);if(a===e){for(var n=0;n<=e;n++)h[t][i+n].toRemove=!0;return e}}}},{key:"findXSameImg",value:function(e,t,i){if(t<m.xNum-e&&h[t+e][i]&&h[t+e][i].toClick){for(var a=0;a<e&&(!h[t+a+1][i]||h[t+a][i].img===h[t+a+1][i].img);a++);if(a===e){for(var n=0;n<=e;n++)h[t+n][i].toRemove=!0;return e}}}},{key:"isDissloved",value:function(){for(var e=0;e<m.xNum;e++)for(var t=0;t<m.yNum;t++)if(h[e][t].toClick)for(var i=2;i<=4;i++)I.findXSameImg(i,e,t),I.findYSameImg(i,e,t);for(var a=0;a<m.xNum;a++)for(var n=0;n<m.yNum;n++)if(h[a][n].toClick&&h[a][n].toRemove)return!0;return!1}},{key:"Dissloved",value:function(){var e=0;h.forEach(function(e,t){e.forEach(function(e,i){if(e.toClick)for(var a=4;a>=2;a--)I.findXSameImg(a,t,i),I.findYSameImg(a,t,i)})});for(var t=0,i=0;i<m.xNum;i++)for(var a=0;a<m.yNum;a++)h[i][a].toClick&&h[i][a].toRemove&&(h[i][a].dissloved(),t++);e+=t>3?2*t*10:10*t;for(var n=function(e){for(var t=function(t){if(h[e][t].toClick&&h[e][t].toRemove){if(setTimeout(function(){h[e][t].refresh()},80),0!==t){for(var i=t-1;i>=0;i--)h[e][i+1].img=h[e][i].img;I.drawNewImg(h,e,0)}else I.drawNewImg(h,e,0);h[e][t].toRemove=!1}},i=0;i<m.yNum;i++)t(i)},s=0;s<m.xNum;s++)n(s);return setTimeout(function(){I.drawStage()},240),I.isDissloved()?{bool:!0,score:e}:{bool:!1,score:e}}},{key:"rewriteClickedImg",value:function(){var e=Array.prototype.slice.call(d.clickedImg);h.forEach(function(t,i){t.forEach(function(i,a){i.toClick&&e.forEach(function(e,i){t[a].img===e&&(t[a].img=d.allImgs[i])})})})}},{key:"currentAllImgsIndex",value:function(e){var t=Array.prototype.slice.call(d.allImgs),i=0,a=e;return t.forEach(function(e,t){a.img===e&&(i=t)}),i}},{key:"continueToDissloved",value:function(){var e=600,t=setInterval(function(){if(d.score<99999){var a=0,n=I.Dissloved();a+=e>=1200?2*n.score:n.score,n.bool||clearInterval(t),d.score+=a,r<d.score&&(r=d.score),s.innerHTML=r,i.innerHTML=d.score,e+=600}},e)}},{key:"nextTouchToDisslove",value:function(){return!0}},{key:"exchangeImg",value:function(e,t){if(e&&t&&e.toClick&&t.toClick){var i=e.img;e.img=t.img,t.img=i}}},{key:"setInitMarginLeft",value:function(){$("#process-current")[0].style.marginLeft="-"+window.getComputedStyle($("#process-current")[0],null).getPropertyValue("width")}},{key:"gameBegin",value:function(){if($(".time-over")){var e,t;!function(){var c=function(e){y+=1,$("#process-current")[0].style.marginLeft=T-x+"px",T+=S,v||(1==k?d.score>=m.passOneNeedScore&&(console.log("pass 1"),t.style.display="block",clearInterval(e),d.score+=m.extraScore*(m.timeCount-parseInt(30*y/1e3)),localStorage.setItem("passOneScore",d.score),h.style.marginLeft=0,r<d.score&&(s.innerHTML=d.score),i.innerHTML=d.score,setTimeout(function(){t.style.display="block"},1e3),setTimeout(function(){t.style.display="none"},3e3),$(".pass-num")[0].innerHTML="二",setTimeout(function(){k=2,d.allImgs=$(".pass-two-imgs .allimg").children(),d.clickedImg=$(".pass-two-imgs .img-clicked").children(),d.disslovedImg=$(".pass-two-imgs .img-dissloved").children(),I.setInitMarginLeft(),I.drawPictures(),I.drawAllStage(),I.gameBegin(),I.continueToDissloved()},3e3)):2==k?d.score>=m.passTwoNeedScore&&(console.log("pass 2"),t.style.display="block",clearInterval(e),d.score+=m.extraScore*(m.timeCount-parseInt(30*y/1e3)),localStorage.setItem("passTwoScore",d.score),h.style.marginLeft=0,r<d.score&&(s.innerHTML=d.score),i.innerHTML=d.score,$(".pass-num")[0].innerHTML="三",setTimeout(function(){t.style.display="block"},1e3),setTimeout(function(){t.style.display="none"},3e3),setTimeout(function(){k=3,d.allImgs=$(".pass-three-imgs .allimg").children(),d.clickedImg=$(".pass-three-imgs .img-clicked").children(),d.disslovedImg=$(".pass-three-imgs .img-dissloved").children(),I.setInitMarginLeft(),I.drawPictures(),I.drawAllStage(),I.gameBegin(),I.continueToDissloved()},3e3)):3==k&&d.score>=m.passThreeNeedScore&&(t.style.display="block",clearInterval(e),d.score+=m.extraScore*(m.timeCount-parseInt(30*y/1e3)),localStorage.setItem("passThreeScore",d.score),h.style.marginLeft=0,r<d.score&&(s.innerHTML=d.score),i.innerHTML=d.score,setTimeout(function(){t.style.display="block"},1e3),setTimeout(function(){t.style.display="none"},3e3),setTimeout(function(){w.style.display="block"},3e3),Ajax({method:"POST",url:$("meta")[0].getAttribute("update-url"),content:"style=cg&score="+d.score+"&time="+m.timeCount+"&stage=3",success:function(e){$(".time-rank")[0].innerHTML=e.data.rank,$(".time-higest-score")[0].innerHTML=e.data.HighScore,d.score<e.data.HighScore&&$(".higest-score")[0].setAttribute("data-class","")}}))),y>=1e3*m.timeCount/30&&(console.log("time out"),clearInterval(e),w.style.display="block",1==k?d.score<m.passOneNeedScore&&(localStorage.setItem("passOneScore",d.score),w.style.display="block",Ajax({method:"POST",url:$("meta")[0].getAttribute("update-url"),content:"style=cg&score="+d.score+"&time="+m.timeCount+"&stage=1",success:function(e){$(".time-rank")[0].innerHTML=e.data.rank,$(".time-higest-score")[0].innerHTML=e.data.HighScore,d.score<e.data.HighScore&&$(".higest-score")[0].setAttribute("data-class","")}})):2==k?d.score<m.passTwoNeedScore&&(localStorage.setItem("passTwoScore",d.score),w.style.display="block",Ajax({method:"POST",url:$("meta")[0].getAttribute("update-url"),content:"style=cg&score="+d.score+"&time="+m.timeCount+"&stage=2",success:function(e){$(".time-rank")[0].innerHTML=e.data.rank,$(".time-higest-score")[0].innerHTML=e.data.HighScore,d.score<e.data.HighScore&&$(".higest-score")[0].setAttribute("data-class","")}})):3==k?d.score<m.passThreeNeedScore&&(localStorage.setItem("passThreeScore",d.score),w.style.display="block",Ajax({method:"POST",url:$("meta")[0].getAttribute("update-url"),content:"style=cg&score="+d.score+"&time="+m.timeCount+"&stage=3",success:function(e){$(".time-rank")[0].innerHTML=e.data.rank,$(".time-higest-score")[0].innerHTML=e.data.HighScore,d.score<e.data.HighScore&&$(".higest-score")[0].setAttribute("data-class","")}})):v&&(localStorage.setItem("timeScore",d.score),w.style.display="block",Ajax({method:"POST",url:$("meta")[0].getAttribute("update-url"),content:"style=js&score="+d.score+"&time="+m.timeCount,success:function(e){$(".time-rank")[0].innerHTML=e.data.rank,$(".time-higest-score")[0].innerHTML=e.data.HighScore,d.score<e.data.HighScore&&$(".higest-score")[0].setAttribute("data-class","")}})),o.innerHTML=d.score)},l=$(".time-over")[0],u=$(".game-stop")[0],g=$(".time-to-stop")[0],f=$(".btn-to-continue")[0],h=$("#process-current")[0],x=($(".rank-detail")[0],Number(getComputedStyle(h).width.slice(0,-3))),S=x/(1e3*m.timeCount/30),T=2*S,w=$(".time-over")[0],b=($(".time-again")[0],!0);$(".score-to-end")&&(e=$(".score-to-end")[0]),m.setWH(l),m.setWH(u),m.setWH(a),$(".next-checkpoint")&&(t=$(".next-checkpoint")[0],m.setWH(t)),n.indexOf("two")>-1?d.score=Number(localStorage.getItem("passOneScore")):n.indexOf("three")>-1&&(d.score=Number(localStorage.getItem("passTwoScore"))),o.innerHTML=d.score,g.addEventListener("click",function(){var t=0;b=!1,u.style.display="block",g.classList.add("time-to-continue"),n.indexOf("one")>-1?t=m.passOneNeedScore-d.score:n.indexOf("two")>-1?t=m.passTwoNeedScore-d.score:n.indexOf("three")>-1&&(t=m.passThreeNeedScore-d.score),t<0&&(t=0),e&&(e.innerHTML=t)},!1),f.addEventListener("click",function(){$(".time-to-continue")[0].classList.remove("time-to-continue"),u.style.display="none";var e=setInterval(function(){p||clearInterval(C),b?c(e):clearInterval(e)},30);b=!0},!1);var C=setInterval(function(){p||clearInterval(C),b?c(C):clearInterval(C)},30)}()}}}]),e}(),S=function(){function e(t,i,a,n,s,r){_classCallCheck(this,e),this.ctx=t,this.x=i,this.y=a,this.img=n,this.toRemove=s,this.toClick=r}return _createClass(e,[{key:"paint",value:function(){this.ctx.drawImage(this.img,this.x,this.y,m.imgWidth,m.imgHeight)}},{key:"refresh",value:function(){this.ctx.clearRect(this.x,this.y,m.imgWidth,m.imgHeight)}},{key:"dissloved",value:function(){var e=I.currentAllImgsIndex(this);this.img=d.disslovedImg[e],I.drawStage()}},{key:"clicked",value:function(){var e=I.currentAllImgsIndex(this);return this.img=d.clickedImg[e],I.drawStage(),e}}]),e}(),I=new x;I.gameBegin(),I.drawPictures(),I.drawAllStage(),(v||1==k)&&Ajax({method:"GET",url:$("meta")[0].getAttribute("show-url"),success:function(e){n.indexOf("time")>-1?e.data.js.myScore>0&&(r=e.data.js.myScore):n.indexOf("pass")>-1&&e.data.js.myScore>0&&(r=e.data.cg.myScore)}}),s.innerHTML=r,I.continueToDissloved(),m.canvas.addEventListener("touchstart",function(e){d.clickedFlag=!1;var e=e||window.event;u={x:e.touches[0].clientX,y:e.touches[0].clientY},g={x:parseInt((u.x-this.offsetLeft)/m.imgWidth)*m.imgWidth,y:parseInt((u.y-this.offsetTop)/m.imgHeight)*m.imgHeight},d.clickedImgIndex=h[g.x/m.imgWidth][g.y/m.imgHeight].clicked(),I.rewriteClickedImg(),d.clickedFlag=!1}),m.canvas.addEventListener("touchmove",function(e){d.moveFlag=!0;var e=e||window.event,t={x:e.touches[0].clientX,y:e.touches[0].clientY};Math.abs(t.y-u.y)<=Math.abs(t.x-u.x)?t.x-u.x>=0?t.x-u.x>=m.halfWidth?f={x:g.x+m.imgWidth,y:g.y}:d.imgPlaceStay():t.x-u.x<=-m.halfWidth?f={x:g.x-m.imgWidth,y:g.y}:d.imgPlaceStay():t.y-u.y>=0?t.y-u.y>=m.halfWidth?f={x:g.x,y:g.y+m.imgHeight}:d.imgPlaceStay():u.y-t.y>=m.halfWidth?f={x:g.x,y:g.y-m.imgHeight}:d.imgPlaceStay()}),m.canvas.addEventListener("touchend",function(e){d.clickedFlag=!1;var t={x:g.x/m.imgWidth,y:g.y/m.imgHeight},i={x:f.x/m.imgWidth,y:f.y/m.imgHeight};if(h[t.x][t.y].img=d.allImgs[d.clickedImgIndex],d.moveFlag)if(h[t.x][t.y].img!==h[i.x][i.y].img&&I.exchangeImg(h[t.x][t.y],h[i.x][i.y]),I.drawStage(),g={x:f.x,y:f.y},I.isDissloved())I.continueToDissloved();else{I.exchangeImg(h[t.x][t.y],h[i.x][i.y]);for(var a=0;a<m.xNum;a++)for(var n=0;n<m.yNum;n++)h[a][n].toClick=!1;setTimeout(function(){for(var e=0;e<m.xNum;e++)for(var t=0;t<m.yNum;t++)h[e][t].toClick=!0;I.drawAllStage(),I.drawStage()},300)}d.moveFlag=!1}),$(".to-homepage").on("click",function(){p=!1,d.score=0,y=0,$(".rank-container").attr("style","display: none"),$(".first-container").attr("style","display: block")}),$(".time-lbtn").on("click",function(){p=!1,y=0,d.score=0,I.setInitMarginLeft();var e=$("body").children("div");e.forEach(function(e,t){e.setAttribute("style","display: none"),console.log(e)}),$(".first-container").attr("style","display: block"),$(".time-title-content .time-to-stop")[0].classList.remove("time-to-continue")}),$(".time-again")[0].addEventListener("click",function(e){y=0,d.score=0,I.setInitMarginLeft(),$(".time-over").attr("style","display: none"),$(".game-stop").attr("style","display: none"),$(".time-title-content .time-to-stop")[0].classList.remove("time-to-continue"),h.forEach(function(e,t){e.forEach(function(e,t){e.refresh(),console.log("test")})}),setTimeout(function(){I.drawPictures(),I.drawAllStage(),I.gameBegin(),I.continueToDissloved()},400)},!1)})}function rankToView(){screen.height<500&&($(".rank-time-list")[0].style.height="4.8rem",$(".rank-pass-list")[0].style.height="4.8rem",$(".rank-cup")[0].style.display="none"),Ajax({method:"GET",url:$("meta")[0].getAttribute("show-url"),success:function(e){e=e.data;var t=$(".rank-time-list")[0],i=$(".rank-time-list .clearfix")[0],a=$(".rank-pass-list")[0],n=$(".rank-pass-list .clearfix")[0],s=$(".me-time")[0],r=$(".me-pass")[0];if(s.firstElementChild.innerHTML=e.js.rank,s.lastElementChild.innerHTML=e.js.myScore,r.firstElementChild.innerHTML=e.cg.rank,r.lastElementChild.innerHTML=e.cg.myScore,e.js.data)for(var o=e.js.data.length,c=0;c<o;c++){var l=document.createElement("li");c<3?l.setAttribute("class","single-detail rank-list-top"):l.setAttribute("class","single-detail"),t.insertBefore(l,i);var m=c+1;l.innerHTML='<span class="rank-num">'+m+'</span><span class="rank-name">'+e.js.data[c].nickname+'</span><span class="rank-score">'+e.js.data[c].score+"</span>"}if(e.cg.data)for(var d=e.cg.data.length,u=0;u<d;u++){var g=document.createElement("li");u<3?g.setAttribute("class","single-detail rank-list-top"):g.setAttribute("class","single-detail"),a.insertBefore(g,n);var f=u+1;g.innerHTML='<span class="rank-num">'+f+'</span><span class="rank-name">'+e.cg.data[u].nickname+'</span><span class="rank-score">'+e.cg.data[u].score+"</span>"}}});var e=$(".rank-btn-time")[0],t=$(".rank-btn-pass")[0],i=$(".rank-time-list")[0],a=$(".rank-pass-list")[0],n=$(".to-nextpage")[0],s="time",r=0,o=0,c=0;e.addEventListener("click",function(){i.style.display="block",a.style.display="none";var t=$(".rank-clicked")[0];t.classList.remove("rank-clicked"),e.classList.add("rank-clicked");var n=i.children;n=Array.prototype.slice.call(n),n.forEach(function(e,t){e.style.display="block"}),s="time",r=0},!1),t.addEventListener("click",function(){i.style.display="none",a.style.display="block";var e=$(".rank-clicked")[0];e.classList.remove("rank-clicked"),t.classList.add("rank-clicked");var n=a.children;n=Array.prototype.slice.call(n),n.forEach(function(e,t){e.style.display="block"}),s="pass",r=0},!1),n.addEventListener("click",function(){var e=void 0;if(r++,"pass"==s?(e=a.children,c=e.length):"time"==s&&(e=i.children,c=e.length),o=parseInt((c-1)/5),(c-1)%5>0&&(o+=1),o>r)for(var t=1;t<c;t++)t<=5*r&&(e[t].style.display="none")},!1)}function Ajax(e){var t=new XMLHttpRequest,i={method:"GET",url:"",async:!0,success:function(){},errer:function(){},content:null};for(var a in e)i[a]=e[a];t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var e=JSON.parse(t.responseText);i.success.call(t,e)}else i.errer()},t.open(i.method,i.url,i.async),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),t.send(i.content)}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}();$(window).on("scroll.elasticity",function(e){e.preventDefault()}).on("touchmove.elasticity",function(e){e.preventDefault()}),$(".mode-time").on("click",function(e){$(".first-container").attr("style","display: none"),$(".game-container").attr("style","display: block"),game(!0)}),$(".mode-pass-through").on("click",function(e){$(".first-container").attr("style","display: none"),$(".game-container").attr("style","display: block"),game(!1)}),$(".ranking-list").on("click",function(e){$(".first-container").attr("style","display: none"),$(".rank-container").attr("style","display: block"),rankToView()});